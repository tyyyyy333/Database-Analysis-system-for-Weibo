<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>明星舆情分析系统 - 明星详情</title>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/star_detail.css">
    <!-- 添加 ECharts 库 -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <!-- 添加中国地图数据 -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/map/js/china.js"></script>
    <!-- 添加真实中国地图数据 -->
    <script src="/js/china_map_real.js"></script>
    <style>
        :root {
            --backgroundColor: #000000;
            --inputColor: #ffffff;
            --primaryColor: #ff69b4;
            --secondaryColor: #ff1493;
            --cardBackground: rgba(255, 255, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            background-color: var(--backgroundColor);
            color: var(--inputColor);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* 导航栏样式 */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            width: 80px;
            background: rgba(0, 0, 0, 0.8);
            border-right: 2px solid var(--inputColor);
            transition: all 0.3s ease;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            padding: 20px 0;
        }

        .sidebar:hover {
            width: 200px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 15px;
            color: var(--inputColor);
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
            margin: 5px 0;
            border-radius: 10px;
            margin: 5px 10px;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--primaryColor);
        }

        .nav-item i {
            font-size: 1.5rem;
            min-width: 40px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .nav-item span {
            opacity: 0;
            transition: all 0.3s ease;
            white-space: nowrap;
            font-size: 1rem;
            margin-left: 10px;
        }

        .sidebar:hover .nav-item span {
            opacity: 1;
        }

        .nav-item.active {
            background: rgba(255, 255, 255, 0.1);
            color: var(--primaryColor);
        }

        .nav-item.active i {
            color: var(--primaryColor);
        }

        /* 主内容区域样式 */
        .main-content {
            margin-left: 80px;
            padding: 20px;
            transition: all 0.3s ease;
            width: calc(100% - 80px);
            max-width: calc(100% - 80px);
            overflow-x: hidden;
        }

        .sidebar:hover + .main-content {
            margin-left: 200px;
            width: calc(100% - 200px);
            max-width: calc(100% - 200px);
        }

        .star-info {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid var(--inputColor);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .star-header {
            display: flex;
            align-items: center;
            gap: 25px;
            margin: 20px 0;
            padding: 0 20px;
        }

        .star-avatar {
            width: 80px;
            height: 80px;
            background: rgba(255, 183, 197, 0.2);
            border: 2px solid #FFB7C5;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            color: #FFB7C5;
            font-weight: bold;
            box-shadow: 0 0 20px rgba(255, 183, 197, 0.2);
        }

        .star-basic-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .star-name {
            font-size: 2rem;
            color: #FFB7C5;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(255, 183, 197, 0.3);
        }

        .star-url {
            color: #FFB7C5;
            text-decoration: none;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .star-url:hover {
            color: #fff;
            text-shadow: 0 0 10px rgba(255, 183, 197, 0.5);
        }

        .star-url i {
            font-size: 1.2rem;
        }

        .star-status {
            display: inline-block;
            padding: 6px 15px;
            background: rgba(255, 183, 197, 0.1);
            border: 1px solid #FFB7C5;
            border-radius: 15px;
            color: #FFB7C5;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .star-intro {
            color: var(--textColor);
            font-size: 1rem;
            line-height: 1.6;
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .star-status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-top: 10px;
        }

        .status-normal {
            background: rgba(0, 255, 0, 0.1);
            color: #00ff00;
        }

        .status-warning {
            background: rgba(255, 165, 0, 0.1);
            color: #ffa500;
        }

        .status-danger {
            background: rgba(255, 0, 0, 0.1);
            color: #ff0000;
        }

        .star-metrics {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-top: 15px;
        }
        
        .metric {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .metric-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
        }

        .chart-section {
            margin-top: 30px;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .chart-card {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid var(--inputColor);
            border-radius: 15px;
            padding: 20px;
            min-height: 300px;
        }

        .chart-title {
            color: var(--textColor);
            font-size: 1.2rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-placeholder {
            width: 100%;
            height: 250px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--textColor);
            font-size: 1rem;
        }

        /* 浮动球动画 */
        .floating-balls {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none; /* Allows clicks to pass through */
            z-index: -1; /* Send to back */
        }

        .ball {
            position: absolute;
            border-radius: 50%;
            opacity: 0;
            animation: floatAndFade 10s infinite ease-in-out;
        }

        @keyframes floatAndFade {
            0% {
                transform: translateY(0) translateX(0) scale(0);
                opacity: 0;
            }
            50% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100vh) translateX(calc(100vw * (var(--random-x) - 0.5))) scale(1);
                opacity: 0;
            }
        }

        /* Custom properties for random movement */
        .ball:nth-child(even) {
            --random-x: 0.2;
        }
        .ball:nth-child(odd) {
            --random-x: 0.8;
        }

        .ball:nth-child(3n) {
            --random-x: 0.5;
        }
        .ball:nth-child(5n) {
            --random-x: 0.7;
        }
        .ball:nth-child(7n) {
            --random-x: 0.3;
        }

        .tab-contents {
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
        }
        
        .tab-content {
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }

        .tabs {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            padding: 0 20px;
            justify-content: flex-end;
            position: relative;
        }

        .back-btn {
            position: absolute;
            top: -65px;
            right: 20px;
            padding: 12px 25px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #FFB7C5;
            border-radius: 25px;
            color: #FFB7C5;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .back-btn:hover {
            background: rgba(255, 183, 197, 0.2);
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(255, 183, 197, 0.2);
        }

        .back-btn i {
            font-size: 1.2rem;
        }

        .tab-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid var(--inputColor);
            color: var(--inputColor);
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            margin-right: 15px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .tab-btn:hover {
            background: rgba(255, 183, 197, 0.2);
            border-color: var(--primaryColor);
            color: var(--primaryColor);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 183, 197, 0.3);
        }

        .tab-btn.active {
            background: var(--primaryColor);
            border-color: var(--primaryColor);
            color: white;
            box-shadow: 0 5px 15px rgba(255, 183, 197, 0.4);
        }

        .events-container {
            padding: 20px;
        }
        
        .events-section {
            margin-bottom: 30px;
        }
        
        .events-section h3 {
            color: var(--inputColor);
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        
        .events-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .event-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s ease;
        }
        
        .event-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        
        .event-content {
            color: var(--inputColor);
            margin-bottom: 10px;
            line-height: 1.5;
        }
        
        .event-meta {
            display: flex;
            justify-content: space-between;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }
        
        .sentiment-score {
            color: #ff4444;
        }
        
        .attitudes-count {
            color: #ffb7c5;
        }

        .fan-demographics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .demographics-card {
            background: #1a1a1a;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }

        .card-header i {
            font-size: 24px;
            margin-right: 10px;
            color: #4a9eff;
        }

        .card-header h3 {
            margin: 0;
            font-size: 18px;
            color: #fff;
        }

        .card-content {
            height: calc(100% - 50px);
        }

        .fans-container {
            padding: 20px;
            width: 100%;
            max-width: 100%;
            overflow: hidden;
        }

        .fans-section {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid var(--inputColor);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            width: 100%;
            max-width: 100%;
            overflow: hidden;
        }

        .fans-section h3 {
            color: var(--primaryColor);
            font-size: 1.8rem;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 0 0 10px rgba(255, 183, 197, 0.2);
        }

        .fans-charts {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 20px;
            width: 100%;
            max-width: 100%;
        }

        .fans-chart {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--borderColor);
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s ease;
            min-height: 450px;
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 100%;
            overflow: hidden;
        }

        .fans-chart:hover {
            border-color: var(--primaryColor);
            box-shadow: 0 0 20px rgba(255, 183, 197, 0.1);
        }

        .fans-chart h4 {
            color: var(--primaryColor);
            font-size: 1.3rem;
            margin-bottom: 15px;
            text-align: center;
            flex-shrink: 0;
        }

        /* 确保地图容器有稳定的尺寸 */
        #locationChart {
            flex: 1;
            min-height: 400px;
            width: 100%;
            max-width: 100%;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 183, 197, 0.2);
            border-radius: 5px;
        }

        #genderChart {
            flex: 1;
            min-height: 300px;
            width: 100%;
            max-width: 100%;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 183, 197, 0.2);
            border-radius: 5px;
        }

        @media (max-width: 768px) {
            .fans-charts {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }

        @media (max-width: 1200px) {
            .fan-demographics {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="floating-balls"></div>

    <div class="sidebar">
        <div class="nav-item" onclick="window.location.href='/home'">
            <i class="ri-home-line"></i>
            <span>首页</span>
        </div>
        <div class="nav-item" onclick="window.location.href='/star_dashboard'">
            <i class="ri-user-star-line"></i>
            <span>明星管理</span>
        </div>
        <div class="nav-item" onclick="window.location.href='/report_dashboard'">
            <i class="ri-file-list-3-line"></i>
            <span>报告管理</span>
        </div>
        <div class="nav-item" onclick="window.location.href='/settings'">
            <i class="ri-settings-4-line"></i>
            <span>系统设置</span>
        </div>
    </div>

    <div class="main-content">
        <div class="container">
            <div class="star-header">
                <div class="star-avatar" id="starAvatar"></div>
                <div class="star-basic-info">
                    <div class="star-name" id="starName"></div>
                    <a class="star-url" id="starUrl" target="_blank">
                        <i class="ri-link"></i>
                        <span id="starUrlText"></span>
                    </a>
                    <div class="star-status" id="starStatus"></div>
                </div>
            </div>

            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('overview')">
                    <i class="ri-dashboard-line"></i>
                    概览
                </button>
                <button class="tab-btn" onclick="switchTab('events')">
                    <i class="ri-calendar-event-line"></i>
                    事件
                </button>
                <button class="tab-btn" onclick="switchTab('fans')">
                    <i class="ri-user-heart-line"></i>
                    粉丝画像
                </button>
                <a href="/star_dashboard.html" class="back-btn">
                    <i class="ri-arrow-left-line"></i>
                    返回列表
                </a>
            </div>

            <div class="tab-contents">
                <div id="overview-content" class="tab-content active">
                    <div class="star-info">
                        <div class="star-intro" id="starIntro"></div>
                        <div class="star-metrics">
                            <div class="metric">
                                <div class="metric-value" id="followerCount">0</div>
                                <div class="metric-label">粉丝数</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value" id="friendsCount">0</div>
                                <div class="metric-label">关注数</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value" id="alertCount">0</div>
                                <div class="metric-label">预警数</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value" id="avgSentiment">0</div>
                                <div class="metric-label">平均情感得分</div>
                            </div>
                        </div>
                    </div>

                    <div class="chart-section">
                        <div class="section-title">数据趋势</div>
                        <div class="chart-grid">
                            <div class="chart-card">
                                <div class="chart-title">
                                    <i class="ri-line-chart-line"></i>
                                    微博热度
                                </div>
                                <div class="chart-placeholder" id="fansTrendChart">
                                    等待数据加载...
                                </div>
                            </div>
                            <div class="chart-card">
                                <div class="chart-title">
                                    <i class="ri-bar-chart-line"></i>
                                    粉丝活跃度
                                </div>
                                <div class="chart-placeholder" id="topicsHeatChart">
                                    等待数据加载...
                                </div>
                            </div>                        
                        </div>
                    </div>
                </div>

                <div id="events-content" class="tab-content">
                    <div class="events-container">
                        <div class="events-section">
                            <h3>恶意事件</h3>
                            <div id="negative-events" class="events-list">
                                <!-- 负面事件将在这里动态生成 -->
                            </div>
                        </div>
                        <div class="events-section">
                            <h3>热门事件</h3>
                            <div id="popular-events" class="events-list">
                                <!-- 热门事件将在这里动态生成 -->
                            </div>
                        </div>
                    </div>
                </div>

                <div id="fans-content" class="tab-content">
                    <div class="fans-container">
                        <div class="fans-section">                            
                            <div class="fans-charts">
                                <div class="fans-chart">
                                    <h4>性别比例</h4>
                                    <div id="genderChart" style="width: 100%; height: 300px;"></div>
                                </div>
                                <div class="fans-chart">
                                    <h4>地区分布</h4>
                                    <div id="locationChart" style="width: 100%; height: 400px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let genderChart = null;
        let regionChart = null;
        // 只在页面加载时获取一次 starId
        const starId = (() => {
            // 支持 /star_detail.html?star_id=xxx 或 /star_detail/xxx
            const url = new URL(window.location.href);
            if (url.searchParams.get('star_id')) {
                return url.searchParams.get('star_id');
            }
            // 兼容 /star_detail/xxx
            const pathParts = window.location.pathname.split('/');
            const last = pathParts[pathParts.length - 1];
            if (last.endsWith('.html')) return null;
            return last;
        })();

        // 更新明星信息
        async function fetchStarData(starId) {
            try {
                // 获取明星基本信息
                const response = await fetch(`/api/stars/${starId}`);
                if (response.ok) {
                    const data = await response.json();
                    updateStarInfo(data);
                }
                
                // 获取预警数和平均情感得分
                const alertResponse = await fetch(`/api/stars/${starId}/alert_count`);
                if (alertResponse.ok) {
                    const alertData = await alertResponse.json();
                    if (alertData.status === 'success') {
                        updateAlertInfo(alertData);
                    }
                }
            } catch (error) {
                console.error('获取明星数据失败:', error);
            }
        }

        function updateStarInfo(star) {
            // 更新明星信息
            document.getElementById('starIntro').innerHTML = `
                <p>${star.description || '暂无简介'}</p>
            `;
            
            // 更新指标
            document.getElementById('followerCount').textContent = star.follower_count || 0;
            document.getElementById('friendsCount').textContent = star.friends_count || 0;
            
            // 更新头像（使用姓氏的第一个字）
            const firstChar = star.nick_name.charAt(0);
            document.getElementById('starAvatar').textContent = firstChar;
        }

        function updateAlertInfo(data) {
            // 更新预警数和情感得分
            document.getElementById('alertCount').textContent = data.alert_count || 0;
            document.getElementById('avgSentiment').textContent = data.avg_sentiment || 0;
            
            // 根据情感得分设置颜色
            const sentimentElement = document.getElementById('avgSentiment');
            if (data.avg_sentiment < 30) {
                sentimentElement.style.color = '#ff4444';  // 红色表示负面
            } else if (data.avg_sentiment < 60) {
                sentimentElement.style.color = '#ffa500';  // 橙色表示中性
            } else {
                sentimentElement.style.color = '#00ff00';  // 绿色表示正面
            }
        }

        // 恢复 tab 切换时渲染图表的逻辑
        async function switchTab(tabName) {
            // 移除所有标签的激活状态
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // 隐藏所有标签内容
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // 激活选中的标签按钮
            const selectedButton = document.querySelector(`[onclick="switchTab('${tabName}')"]`);
            if (selectedButton) {
                selectedButton.classList.add('active');
            }
            
            // 显示选中的标签内容
            const selectedContent = document.getElementById(`${tabName}-content`);
            if (selectedContent) {
                selectedContent.classList.add('active');
            }
            
            // 如果切换到事件标签，加载事件数据
            if (tabName === 'events') {
                loadEvents();
            }
            
            // 如果切换到粉丝画像标签，加载粉丝画像数据
            if (tabName === 'fans') {
                fetchFanDemographics(starId);
            }
        }

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 确保概览标签内容显示
            const overviewContent = document.getElementById('overview-content');
            if (overviewContent) {
                overviewContent.classList.add('active');
            }
            
            // 确保概览按钮处于激活状态
            const overviewButton = document.querySelector('[onclick="switchTab(\'overview\')"]');
            if (overviewButton) {
                overviewButton.classList.add('active');
            }
        });

        // 页面加载完成后获取数据
        document.addEventListener('DOMContentLoaded', () => {
            fetchStarData(starId);
            // 渲染性别和地域分布图表
            fetchFanDemographics(starId);
        });

        // 浮动球动画
        function createFloatingBalls(count) {
            const container = document.querySelector('.floating-balls');
            if (!container) return;
            container.innerHTML = ''; // Clear existing balls

            const colors = [
                'rgba(255, 255, 255, 0.1)',
                'rgba(255, 255, 255, 0.15)',
                'rgba(255, 255, 255, 0.2)'
            ];

            for (let i = 0; i < count; i++) {
                const ball = document.createElement('div');
                ball.classList.add('ball');
                const size = Math.random() * 60 + 20; // Size between 20px and 80px
                ball.style.width = `${size}px`;
                ball.style.height = `${size}px`;
                ball.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                ball.style.left = `${Math.random() * 100}%`;
                ball.style.top = `${Math.random() * 100}%`;
                ball.style.animationDuration = `${Math.random() * 10 + 5}s`; // Duration between 5s and 15s
                ball.style.animationDelay = `${Math.random() * 5}s`; // Delay up to 5s
                ball.style.boxShadow = `0 0 ${size / 4}px rgba(255, 255, 255, 0.1)`;
                container.appendChild(ball);
            }
        }

        // 初始化浮动球
        createFloatingBalls(15); // 创建15个浮动球

        // 窗口大小改变时重新生成浮动球
        window.addEventListener('resize', () => {
            createFloatingBalls(15);
        });

        function updateStarsGrid(stars) {
            const grid = document.getElementById('starsGrid');
            grid.innerHTML = `
                <div class="add-star-card" onclick="showAddStarModal()">
                    <i class="ri-add-circle-line add-star-icon"></i>
                    <div class="add-star-text">添加明星</div>
                </div>
                ${stars.map(star => `
                    <div class="star-card">
                        <div class="star-card-header">
                            <div class="star-card-avatar">${star.nick_name.charAt(0)}</div>
                            <div class="star-card-name">${star.nick_name}</div>
                        </div>
                        <div class="star-card-metrics">
                            <div class="star-card-metric">
                                <div class="star-card-metric-value">${star.friends_count || 0}</div>
                                <div class="star-card-metric-label">关注数</div>
                            </div>
                            <div class="star-card-metric">
                                <div class="star-card-metric-value">${star.follower_count || 0}</div>
                                <div class="star-card-metric-label">粉丝数</div>
                            </div>
                            <div class="star-card-metric">
                                <div class="star-card-metric-value">${star.gender || '未知'}</div>
                                <div class="star-card-metric-label">性别</div>
                            </div>
                            <div class="star-card-metric">
                                <div class="star-card-metric-value">${star.location || '未知'}</div>
                                <div class="star-card-metric-label">IP</div>
                            </div>
                            <div class="star-card-metric">
                                <div class="star-card-metric-value">${star.profession || '未知'}</div>
                                <div class="star-card-metric-label">职业</div>
                            </div>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        // 获取微博热度数据
        async function fetchHeatData() {
            try {
                const response = await fetch(`/api/stars/${starId}/heat`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'success') {
                        const heatChart = echarts.init(document.getElementById('fansTrendChart'));
                        heatChart.setOption({
                            title: {
                                text: '微博热度',
                                textStyle: {
                                    color: '#FFB7C5'
                                }
                            },
                            tooltip: {
                                trigger: 'axis'
                            },
                            xAxis: {
                                type: 'category',
                                data: data.heat_data.map(item => item.date),
                                axisLabel: {
                                    color: '#fff'
                                }
                            },
                            yAxis: {
                                type: 'value',
                                axisLabel: {
                                    color: '#fff'
                                }
                            },
                            series: [{
                                data: data.heat_data.map(item => item.heat_score),
                                type: 'bar',
                                itemStyle: {
                                    color: '#FFB7C5'
                                }
                            }]
                        });
                    } else {
                        showErrorMessage(data.message || '获取微博热度失败');
                    }
                } else {
                    showErrorMessage('获取微博热度失败');
                }
            } catch (error) {
                showErrorMessage('获取微博热度失败：' + error.message);
            }
        }

        // 获取粉丝活跃度数据
        async function fetchActivityData() {
            try {
                const response = await fetch(`/api/stars/${starId}/activity`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'success') {
                        const activityChart = echarts.init(document.getElementById('topicsHeatChart'));
                        activityChart.setOption({
                            title: {
                                text: '粉丝活跃度',
                                textStyle: {
                                    color: '#FFB7C5'
                                }
                            },
                            tooltip: {
                                trigger: 'axis'
                            },
                            xAxis: {
                                type: 'category',
                                data: data.activity_data.map(item => item.date),
                                axisLabel: {
                                    color: '#fff'
                                }
                            },
                            yAxis: {
                                type: 'value',
                                axisLabel: {
                                    color: '#fff'
                                }
                            },
                            series: [{
                                data: data.activity_data.map(item => item.activity_score),
                                type: 'bar',
                                itemStyle: {
                                    color: '#FFB7C5'
                                }
                            }]
                        });
                    } else {
                        showErrorMessage(data.message || '获取粉丝活跃度失败');
                    }
                } else {
                    showErrorMessage('获取粉丝活跃度失败');
                }
            } catch (error) {
                showErrorMessage('获取粉丝活跃度失败：' + error.message);
            }
        }

        // 页面加载时获取数据
        window.addEventListener('load', () => {
            fetchHeatData();
            fetchActivityData();
        });

        // 获取粉丝画像数据
        async function fetchFanDemographics(starId) {
            console.log('开始获取粉丝画像数据，明星ID:', starId);
            try {
                // 获取性别数据
                const genderResponse = await fetch(`/api/stars/${starId}/gender`);
                const genderData = await genderResponse.json();
                
                // 获取地区数据
                const regionResponse = await fetch(`/api/stars/${starId}/region`);
                const regionData = await regionResponse.json();
                
                if (genderData.status === 'success') {
                    renderGenderChart(genderData.gender_data);
                }
                
                if (regionData.status === 'success') {
                    renderRegionChart(starId, regionData.region_data);
                }
            } catch (error) {
                console.error('获取粉丝画像数据失败:', error);
            }
        }

        // 渲染性别分布图
        function renderGenderChart(genderData) {
            console.log('开始渲染性别分布图...');
            
            const genderChartDom = document.getElementById('genderChart');
            if (!genderChartDom) {
                console.error('找不到性别图容器 genderChart');
                return;
            }
            
            // 清理之前的图表实例
            if (genderChart) {
                try {
                    echarts.dispose(genderChart);
                    genderChart = null;
                } catch (e) {
                    console.log('清理旧性别图表实例时出错:', e);
                }
            }
            
            // 确保容器有正确的尺寸和居中样式
            genderChartDom.style.height = '300px';
            genderChartDom.style.width = '100%';
            genderChartDom.style.minHeight = '300px';
            genderChartDom.style.minWidth = '300px';
            genderChartDom.style.position = 'relative';
            genderChartDom.style.overflow = 'hidden';
            genderChartDom.style.display = 'flex';
            genderChartDom.style.justifyContent = 'center';
            genderChartDom.style.alignItems = 'center';
            genderChartDom.innerHTML = '';
            
            if (!genderData || genderData.length === 0) {
                genderChartDom.innerHTML = '<div style="color:#FFB7C5;text-align:center;line-height:300px;">暂无性别分布数据</div>';
                return;
            }
            
            console.log('性别数据:', genderData);
            
            // 延迟初始化，确保容器尺寸稳定
            setTimeout(() => {
                try {
                    console.log('开始初始化性别图...');
                    console.log('性别图容器尺寸:', {
                        width: genderChartDom.offsetWidth,
                        height: genderChartDom.offsetHeight,
                        clientWidth: genderChartDom.clientWidth,
                        clientHeight: genderChartDom.clientHeight
                    });
                    
                    genderChart = echarts.init(genderChartDom);
                    const option = {
                        backgroundColor: 'transparent',
                        title: {
                            text: '性别比例',
                            textStyle: {
                                color: '#FFB7C5',
                                fontSize: 16,
                                fontWeight: 'bold'
                            },
                            left: 'center',
                            top: 10
                        },
                        tooltip: {
                            trigger: 'item',
                            formatter: '{b}: {c} ({d}%)'
                        },
                        legend: {
                            orient: 'horizontal',
                            bottom: 10,
                            left: 'center',
                            textStyle: {
                                color: '#fff',
                                fontSize: 14
                            }
                        },
                        series: [{
                            name: '性别比例',
                            type: 'pie',
                            radius: ['40%', '70%'],
                            center: ['50%', '50%'],
                            avoidLabelOverlap: false,
                            itemStyle: {
                                borderRadius: 8,
                                borderColor: '#fff',
                                borderWidth: 2,
                                shadowBlur: 10,
                                shadowColor: 'rgba(255,183,197,0.3)'
                            },
                            label: {
                                show: true,
                                color: '#fff',
                                fontSize: 14,
                                formatter: '{b}: {d}%'
                            },
                            data: genderData.map(item => ({
                                ...item,
                                itemStyle: {
                                    color: item.name === '女' ? '#FFB7C5' : '#006edd'
                                }
                            }))
                        }]
                    };
                    
                    genderChart.setOption(option);
                    console.log('性别图渲染成功，图表实例:', genderChart);
                    
                    // 强制重新渲染
                    setTimeout(() => {
                        if (genderChart && !genderChart.isDisposed()) {
                            genderChart.resize();
                            console.log('性别图重新调整尺寸完成');
                        }
                    }, 100);
                    
                    // 响应式调整
                    const resizeHandler = () => {
                        if (genderChart && !genderChart.isDisposed()) {
                            genderChart.resize();
                        }
                    };
                    
                    window.addEventListener('resize', resizeHandler);
                    
                    // 保存清理函数
                    genderChart._cleanup = () => {
                        window.removeEventListener('resize', resizeHandler);
                    };
                    
                } catch (error) {
                    console.error('渲染性别图失败:', error);
                    genderChartDom.innerHTML = `<div style="color:#FFB7C5;text-align:center;line-height:300px;">性别图渲染失败: ${error.message}</div>`;
                }
            }, 100);
        }

        // 渲染地区分布图
        function renderRegionChart(starId, regionData) {
            console.log('开始渲染地区分布图...');
            
            const regionDom = document.getElementById('locationChart');
            if (!regionDom) {
                console.error('找不到地图容器 locationChart');
                return;
            }
            
            // 清理之前的图表实例
            if (regionChart) {
                try {
                    echarts.dispose(regionChart);
                    regionChart = null;
                } catch (e) {
                    console.log('清理旧图表实例时出错:', e);
                }
            }
            
            if (regionDom._echarts_instance_) {
                try {
                    echarts.dispose(regionDom);
                } catch (e) {
                    console.log('清理DOM图表实例时出错:', e);
                }
            }
            
            // 确保容器有正确的尺寸
            regionDom.style.height = '400px';
            regionDom.style.width = '100%';
            regionDom.style.minHeight = '400px';
            regionDom.style.minWidth = '300px';
            regionDom.style.position = 'relative';
            regionDom.style.overflow = 'hidden';
            regionDom.innerHTML = '';
            
            if (!regionData || regionData.length === 0) {
                regionDom.innerHTML = '<div style="color:#FFB7C5;text-align:center;line-height:400px;">暂无地区分布数据</div>';
                return;
            }
            
            console.log('原始数据:', regionData);
            
            // 处理数据，标准化省份名称
            const processedData = regionData.reduce((arr, item) => {
                let province = item.name;
                
                if (province) {
                    province = province.trim();
                    if (province.includes(' ')) {
                        province = province.split(' ')[0];
                    }
                    province = province.replace(/[^\u4e00-\u9fa5]/g, '');
                }
                
                if (!province || province === '其他' || province === '海外' || province === '未知' || province === '香港' || province === '台湾') {
                    return arr;
                }
                
                const provinceMap = {
                    '北京': '北京', '天津': '天津', '河北': '河北', '山西': '山西',
                    '内蒙古': '内蒙古', '辽宁': '辽宁', '吉林': '吉林', '黑龙江': '黑龙江',
                    '上海': '上海', '江苏': '江苏', '浙江': '浙江', '安徽': '安徽',
                    '福建': '福建', '江西': '江西', '山东': '山东', '河南': '河南',
                    '湖北': '湖北', '湖南': '湖南', '广东': '广东', '广西': '广西',
                    '海南': '海南', '重庆': '重庆', '四川': '四川', '贵州': '贵州',
                    '云南': '云南', '西藏': '西藏', '陕西': '陕西', '甘肃': '甘肃',
                    '青海': '青海', '宁夏': '宁夏', '新疆': '新疆'
                };
                
                const normalizedProvince = provinceMap[province];
                if (!normalizedProvince) {
                    console.log('跳过无效省份:', province);
                    return arr;
                }
                
                let found = arr.find(d => d.name === normalizedProvince);
                if (found) {
                    found.value += item.value;
                } else {
                    arr.push({name: normalizedProvince, value: item.value});
                }
                return arr;
            }, []);
            
            console.log('处理后的数据:', processedData);
            
            if (processedData.length === 0) {
                regionDom.innerHTML = '<div style="color:#FFB7C5;text-align:center;line-height:400px;">暂无有效地区分布数据</div>';
                return;
            }
            
            // 检查中国地图是否已加载
            const chinaMap = echarts.getMap('china');
            console.log('中国地图状态:', chinaMap ? '已加载' : '未加载');
            
            if (!chinaMap) {
                console.error('中国地图数据未加载，尝试重新加载');
                regionDom.innerHTML = '<div style="color:#FFB7C5;text-align:center;line-height:400px;">地图数据加载中...</div>';
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/echarts@5.4.3/map/js/china.js';
                script.onload = function() {
                    console.log('中国地图数据加载成功，重新渲染图表');
                    setTimeout(() => renderRegionChart(starId, regionData), 500);
                };
                script.onerror = function() {
                    console.error('中国地图数据加载失败');
                    regionDom.innerHTML = '<div style="color:#FFB7C5;text-align:center;line-height:400px;">地图数据加载失败</div>';
                };
                document.head.appendChild(script);
                return;
            }
            
            // 延迟初始化，确保容器尺寸稳定
            setTimeout(() => {
                try {
                    console.log('开始初始化地图...');
                    console.log('容器尺寸:', {
                        width: regionDom.offsetWidth,
                        height: regionDom.offsetHeight,
                        clientWidth: regionDom.clientWidth,
                        clientHeight: regionDom.clientHeight
                    });
                    
                    // 创建新的图表实例
                    regionChart = echarts.init(regionDom);
                    
                    const maxValue = Math.max(...processedData.map(d => d.value));
                    const minValue = Math.min(...processedData.map(d => d.value));
                    const totalFans = processedData.reduce((sum, item) => sum + item.value, 0);
                    
                    console.log('数据统计:', {
                        totalFans: totalFans,
                        maxValue: maxValue,
                        minValue: minValue,
                        provinceCount: processedData.length
                    });
                    
                    const option = {
                        backgroundColor: 'transparent',
                        title: {
                            text: '粉丝地区分布',
                            subtext: '基于真实中国地图边界数据',
                            left: 'center',
                            top: 10,
                            textStyle: {
                                color: '#FFB7C5',
                                fontSize: 16,
                                fontWeight: 'bold'
                            },
                            subtextStyle: {
                                color: '#fff',
                                fontSize: 12
                            }
                        },
                        tooltip: {
                            trigger: 'item',
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            borderColor: '#FFB7C5',
                            borderWidth: 1,
                            textStyle: {
                                color: '#333'
                            },
                            formatter: function(params) {
                                if (params.data) {
                                    const percentage = ((params.data.value / totalFans) * 100).toFixed(1);
                                    return `
                                        <div style="padding: 10px;">
                                            <div style="font-weight: bold; color: #FFB7C5; margin-bottom: 5px;">${params.name}</div>
                                            <div>粉丝数量: <strong>${params.data.value}</strong> 人</div>
                                            <div>占比: <strong>${percentage}%</strong></div>
                                        </div>
                                    `;
                                }
                                return `${params.name}<br/>暂无数据`;
                            }
                        },
                        visualMap: {
                            min: minValue,
                            max: maxValue,
                            left: 'left',
                            top: 'bottom',
                            text: ['高密度', '低密度'],
                            calculable: true,
                            inRange: {
                                color: ['#e0f3f8', '#fee090', '#fdae61', '#f46d43', '#d73027']
                            },
                            textStyle: {
                                color: '#fff',
                                fontSize: 12
                            }
                        },
                        series: [{
                            name: '粉丝分布',
                            type: 'map',
                            map: 'china',
                            roam: true,
                            zoom: 1.2,
                            center: [105, 36],
                            emphasis: {
                                label: {
                                    show: true,
                                    color: '#333'
                                },
                                itemStyle: {
                                    areaColor: '#FFB7C5',
                                    shadowOffsetX: 0,
                                    shadowOffsetY: 0,
                                    shadowBlur: 20,
                                    borderWidth: 0,
                                    shadowColor: 'rgba(255, 183, 197, 0.5)'
                                }
                            },
                            itemStyle: {
                                borderColor: '#fff',
                                borderWidth: 1
                            },
                            data: processedData
                        }]
                    };
                    
                    regionChart.setOption(option);
                    console.log('地区分布图渲染成功，图表实例:', regionChart);
                    
                    // 强制重新渲染
                    setTimeout(() => {
                        if (regionChart && !regionChart.isDisposed()) {
                            regionChart.resize();
                            console.log('地图重新调整尺寸完成');
                        }
                    }, 100);
                    
                    // 定期检查图表状态
                    const checkInterval = setInterval(() => {
                        if (regionChart && !regionChart.isDisposed()) {
                            console.log('图表状态正常');
                        } else {
                            console.warn('图表实例丢失，尝试重新创建');
                            clearInterval(checkInterval);
                            setTimeout(() => renderRegionChart(starId, regionData), 1000);
                        }
                    }, 5000);
                    
                    // 响应式调整
                    const resizeHandler = () => {
                        if (regionChart && !regionChart.isDisposed()) {
                            regionChart.resize();
                        }
                    };
                    
                    window.addEventListener('resize', resizeHandler);
                    
                    // 保存清理函数
                    regionChart._cleanup = () => {
                        clearInterval(checkInterval);
                        window.removeEventListener('resize', resizeHandler);
                    };
                    
                } catch (error) {
                    console.error('渲染地图失败:', error);
                    regionDom.innerHTML = `<div style="color:#FFB7C5;text-align:center;line-height:400px;">地图渲染失败: ${error.message}</div>`;
                }
            }, 300);
        }

        async function loadEvents() {
            // 用全局 starId
            console.log('loadEvents starId:', starId);
            if (!starId) {
                document.getElementById('negative-events').innerHTML = '<div style="color:#FFB7C5;text-align:center;">未获取到明星ID</div>';
                document.getElementById('popular-events').innerHTML = '<div style="color:#FFB7C5;text-align:center;">未获取到明星ID</div>';
                return;
            }
            try {
                // 加载负面事件
                const negativeResponse = await fetch(`/api/stars/${starId}/negative_events`);
                let negativeData = { status: 'error', events: [] };
                if (negativeResponse.ok) {
                    negativeData = await negativeResponse.json();
                }
                console.log('负面事件数据:', negativeData);
                if (negativeData.status === 'success' && negativeData.events.length > 0) {
                    const negativeEventsHtml = negativeData.events.map(event => `
                        <div class="event-item">
                            <div class="event-content">${event.content}</div>
                            <div class="event-meta">
                                <span class="sentiment-score">情感分数: ${event.sentiment_score}</span>
                                <span>${event.created_at}</span>
                            </div>
                        </div>
                    `).join('');
                    document.getElementById('negative-events').innerHTML = negativeEventsHtml;
                } else {
                    document.getElementById('negative-events').innerHTML = '<div style="color:#FFB7C5;text-align:center;">暂无事件</div>';
                }
                // 加载热门事件
                const popularResponse = await fetch(`/api/stars/${starId}/popular_events`);
                let popularData = { status: 'error', events: [] };
                if (popularResponse.ok) {
                    popularData = await popularResponse.json();
                }
                console.log('热门事件数据:', popularData);
                if (popularData.status === 'success' && popularData.events.length > 0) {
                    const popularEventsHtml = popularData.events.map(event => `
                        <div class="event-item">
                            <div class="event-content">${event.content}</div>
                            <div class="event-meta">
                                <span class="attitudes-count">点赞数: ${event.attitudes_count}</span>
                                <span>${event.created_at}</span>
                            </div>
                        </div>
                    `).join('');
                    document.getElementById('popular-events').innerHTML = popularEventsHtml;
                } else {
                    document.getElementById('popular-events').innerHTML = '<div style="color:#FFB7C5;text-align:center;">暂无事件</div>';
                }
            } catch (error) {
                console.error('加载事件数据失败:', error);
                document.getElementById('negative-events').innerHTML = '<div style="color:#FFB7C5;text-align:center;">加载失败</div>';
                document.getElementById('popular-events').innerHTML = '<div style="color:#FFB7C5;text-align:center;">加载失败</div>';
            }
        }
    </script>
</body>
</html> 